<div class="fx-container">
  <section class="fx-card fx-pad">
    <div class="fx-head">
      <div>
        <h2 class="fx-title">Raw Inventory</h2>
        <div class="fx-sub">Track batches & expiry across locations • FEFO ready</div>
      </div>
      <div class="fx-head-actions">
        <span class="fx-sub">Scope: <b>{{ scopeLabel() }}</b></span>
        <a class="fx-btnlink fx-btn-ghost" routerLink="/inventory/create">+ Create SKU</a>
      </div>
    </div>

    <div class="fx-row" style="margin-top: 14px;">
      <input
        class="fx-input"
        [value]="q()"
        (input)="q.set(($any($event.target)).value)"
        placeholder="Search SKU / Name / Category"
      />

      <select
        class="fx-select"
        [value]="scopeMode() === 'ALL' ? 'ALL' : selectedLocationId()"
        (change)="($any($event.target)).value === 'ALL' ? setScopeAll() : setScopeOne(($any($event.target)).value)"
      >
        <option value="ALL">All Locations</option>
        <option *ngFor="let l of locations()" [value]="l.id">{{ l.name }}</option>
      </select>

      <select
        class="fx-select"
        [value]="expDays() === null ? 'NONE' : expDays()"
        (change)="($any($event.target)).value === 'NONE' ? expDays.set(null) : expDays.set(+($any($event.target)).value)"
      >
        <option value="30">Expiring ≤ 30d</option>
        <option value="15">Expiring ≤ 15d</option>
        <option value="7">Expiring ≤ 7d</option>
        <option value="NONE">No expiry filter</option>
      </select>

      <label class="fx-check">
        <input type="checkbox" [checked]="lowOnly()" (change)="lowOnly.set(($any($event.target)).checked)" />
        Low stock
      </label>

      <label class="fx-check">
        <input type="checkbox" [checked]="showInactive()" (change)="showInactive.set(($any($event.target)).checked)" />
        Show inactive
      </label>

      <div class="fx-spacer"></div>
    </div>

    <table class="fx-table">
      <thead>
      <tr>
        <th class="fx-th">SKU</th>
        <th class="fx-th">Name</th>
        <th class="fx-th">Category</th>
        <th class="fx-th">HSN/SAC</th>
        <th class="fx-th fx-num">Stock</th>
        <th class="fx-th">Earliest Expiry</th>
        <th class="fx-th">Status</th>
        <th class="fx-th">Risk</th>
        <th class="fx-th"></th>
      </tr>
      </thead>

      <tbody>
      <ng-container *ngFor="let r of rows()">
        <tr class="fx-tr">
          <td class="fx-td fx-mono">{{ r.item.sku }}</td>
          <td class="fx-td">{{ r.item.name }}</td>
          <td class="fx-td">{{ r.item.category }}</td>
          <td class="fx-td fx-mono">{{ r.item.hsnSac ?? '-' }}</td>
          <td class="fx-td fx-num">{{ r.qty }}</td>
          <td class="fx-td fx-mono">{{ r.earliest ?? '-' }}</td>
          <td class="fx-td">{{ r.item.status }}</td>
          <td class="fx-td">
            <span class="fx-pill bad" *ngIf="r.expired">Expired</span>
            <span class="fx-pill warn" *ngIf="!r.expired && r.expSoon">Expiring</span>
            <span class="fx-pill low" *ngIf="r.low">Low</span>
            <span class="fx-pill ok" *ngIf="!r.expired && !r.expSoon && !r.low">OK</span>
          </td>
          <td class="fx-td" style="text-align:right;">
            <button class="pill-btn" type="button" (click)="toggle(r.item.id)" [attr.aria-expanded]="openId() === r.item.id">
              <span class="fx-btnlink">Details</span>
              <span class="chevron">{{ openId() === r.item.id ? '▲' : '▼' }}</span>
            </button>
          </td>
        </tr>
        <tr class="fx-detail" *ngIf="openId() === r.item.id">
          <td class="fx-td" colspan="9">
            <div class="detail-card">
              <div class="detail-head">
                <div>
                  <div class="detail-title">{{ r.item.name }}</div>
                  <div class="detail-sub">SKU {{ r.item.sku }} • {{ r.item.category }}</div>
                </div>
                <div class="detail-actions">
                  <a class="fx-btnlink" [routerLink]="['/inventory', r.item.id]">View</a>
                  <a class="fx-btnlink" [routerLink]="['/inventory', r.item.id, 'issue']">Issue / Consume</a>
                </div>
              </div>

              <div class="detail-grid">
                <div class="metric">
                  <div class="label">Stock</div>
                  <div class="value">{{ r.qty }}</div>
                </div>
                <div class="metric">
                  <div class="label">Min</div>
                  <div class="value">{{ r.min }}</div>
                </div>
                <div class="metric">
                  <div class="label">HSN/SAC</div>
                  <div class="value mono">{{ r.item.hsnSac || '-' }}</div>
                </div>
                <div class="metric">
                  <div class="label">Earliest Expiry</div>
                  <div class="value mono">{{ r.earliest || '-' }}</div>
                </div>
                <div class="metric">
                  <div class="label">Scope</div>
                  <div class="value">{{ scopeLabel() }}</div>
                </div>
                <div class="metric">
                  <div class="label">Tags</div>
                  <div class="value">{{ r.item.tags?.join(', ') || '-' }}</div>
                </div>
              </div>
            </div>
          </td>
        </tr>
      </ng-container>
      <tr *ngIf="rows().length === 0">
        <td class="fx-td fx-empty" colspan="9">
          No items match filters. <a routerLink="/inventory/create" class="fx-btnlink">Add Item</a>
        </td>
      </tr>
      </tbody>
    </table>
  </section>
</div>
