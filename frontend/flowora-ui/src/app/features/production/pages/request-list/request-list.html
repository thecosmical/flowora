<div class="fx-container">
  <section class="fx-card fx-pad">
    <div class="fx-head">
      <div>
        <h2 class="fx-title">Production Requests</h2>
        <div class="fx-sub">Requested → Approved → Used/Returned/Rejected, with approvers.</div>
      </div>
      <div class="fx-head-actions">
        <a class="fx-btnlink fx-btn-ghost" routerLink="/production/request/new">+ New Request</a>
      </div>
    </div>

    <div class="fx-row" style="margin-top:14px;">
      <input class="fx-input" placeholder="Search request / product / requester"
             [value]="q()" (input)="q.set(($any($event.target)).value)" />

      <select class="fx-select" [value]="status()" (change)="status.set(($any($event.target)).value)">
        <option value="ALL">All status</option>
        <option value="PENDING">Pending</option>
        <option value="APPROVED">Approved</option>
        <option value="REJECTED">Rejected</option>
        <option value="CLOSED">Closed</option>
      </select>

      <select class="fx-select" [value]="type()" (change)="type.set(($any($event.target)).value)">
        <option value="ALL">All types</option>
        <option value="ISSUE">Inventory Issue</option>
        <option value="PURCHASE">Purchase</option>
      </select>

      <div class="fx-spacer"></div>
    </div>

    <table class="fx-table">
      <thead>
      <tr>
        <th class="fx-th">Req ID</th>
        <th class="fx-th">Product</th>
        <th class="fx-th">Type</th>
        <th class="fx-th">Requested</th>
        <th class="fx-th">Approved</th>
        <th class="fx-th">Used</th>
        <th class="fx-th">Returned</th>
        <th class="fx-th">Rejected</th>
        <th class="fx-th">Approvers</th>
        <th class="fx-th fx-num">Status</th>
        <th class="fx-th fx-num">Details</th>
      </tr>
      </thead>
      <tbody>
      <ng-container *ngFor="let r of rows()">
        <tr class="fx-tr">
          <td class="fx-td fx-mono">{{ r.id }}</td>
          <td class="fx-td">
            <div><a class="fx-btnlink" [routerLink]="['/production/product', r.product?.id]">{{ r.product?.name ?? 'Product' }}</a></div>
            <div class="fx-sub">{{ r.product?.sku }}</div>
          </td>
          <td class="fx-td">{{ r.type === 'ISSUE' ? 'Inventory Issue' : 'Purchase' }}</td>
          <td class="fx-td">{{ r.targetQty }}</td>
          <td class="fx-td">{{ r.totals.approved }}</td>
          <td class="fx-td">{{ r.totals.used }}</td>
          <td class="fx-td">{{ r.totals.returned }}</td>
          <td class="fx-td">{{ r.totals.rejected }}</td>
          <td class="fx-td">
            <span class="fx-pill">{{ r.approvers.join(', ') }}</span>
          </td>
          <td class="fx-td fx-num">
            <button class="pill-btn" type="button" (click)="toggle(r.id)" [attr.aria-expanded]="openId() === r.id">
              <span class="fx-pill" [ngClass]="r.status.toLowerCase()">{{ r.status }}</span>
              <span class="chevron">{{ openId() === r.id ? '▲' : '▼' }}</span>
            </button>
          </td>
        </tr>
        <tr class="fx-detail" *ngIf="openId() === r.id">
          <td class="fx-td" colspan="11">
            <div class="detail-card">
              <div class="detail-row">
                <div><strong>Requested By:</strong> {{ r.requestedBy }}</div>
                <div><strong>Approved By:</strong> {{ r.approvedBy?.join(', ') || 'Pending' }}</div>
                <div><strong>Docs:</strong> {{ r.docs?.join(' • ') || 'Placeholder' }} <button class="link" type="button">Attach (placeholder)</button></div>
              </div>
              <div class="detail-row">
                <div><strong>Totals:</strong> Used {{ r.totals.used }} • Returned {{ r.totals.returned }} • Rejected {{ r.totals.rejected }}</div>
                <div><strong>Status:</strong> {{ r.status }}</div>
              </div>
              <div class="lines">
                <div class="line-head">Lines</div>
                <div class="line-row" *ngFor="let l of r.lines">
                  <span class="mono">{{ l.itemId }}</span>
                  <span>Req {{ l.requestedQty }}</span>
                  <span>App {{ l.approvedQty }}</span>
                  <span>Used {{ l.usedQty }}</span>
                  <span>Ret {{ l.returnedQty }}</span>
                  <span>Rej {{ l.rejectedQty }}</span>
                  <span class="reason">{{ l.reason || '' }}</span>
                </div>
              </div>
              <div class="history">
                <div class="line-head">Activity</div>
                <div class="hist-row" *ngFor="let e of eventsFor(r.id)">
                  <span class="pill" [ngClass]="e.kind.toLowerCase()">{{ e.kind }}</span>
                  <span class="mono">{{ e.at }}</span>
                  <span>{{ e.by }}</span>
                  <span>{{ e.qty }}</span>
                  <span class="reason">{{ e.reason || '' }}</span>
                </div>
                <div class="fx-empty" *ngIf="eventsFor(r.id).length === 0">No activity yet.</div>
              </div>
            </div>
          </td>
        </tr>
      </ng-container>
      <tr *ngIf="rows().length === 0">
        <td class="fx-td fx-empty" colspan="11">No requests match filters.</td>
      </tr>
      </tbody>
    </table>
  </section>
</div>
